# Cart Module - Оптимизированная версия

## Обзор

Cart модуль предоставляет функциональность для управления корзиной покупок пользователей. Модуль оптимизирован для высокой производительности и масштабируемости.

## Основные улучшения

### 1. Производительность
- **Batch операции**: Добавлены методы для работы с несколькими товарами одновременно
- **Оптимизированные запросы**: Улучшены SQL запросы с использованием индексов
- **Умное кеширование**: Кеширование корзины и количества товаров
- **Параллельные операции**: Использование Promise.all для одновременных запросов

### 2. Валидация и безопасность
- **Строгая валидация**: Все входные данные валидируются
- **Обработка ошибок**: Детальные сообщения об ошибках
- **Защита от дублирования**: Уникальные индексы в базе данных

### 3. API Endpoints

#### Основные операции
- `POST /cart/:productId` - Добавить товар в корзину
- `DELETE /cart/:productId` - Удалить товар из корзины
- `GET /cart` - Получить корзину пользователя
- `DELETE /cart` - Очистить корзину

#### Batch операции
- `POST /cart/multiple` - Добавить несколько товаров
- `DELETE /cart/multiple` - Удалить несколько товаров

#### Информационные endpoints
- `GET /cart/count` - Получить количество товаров
- `GET /cart/status` - Проверить статус товаров в корзине

## Структура модуля

```
cart/
├── cart.controller.ts      # Контроллер с API endpoints
├── cart.services.ts        # Бизнес-логика
├── cart.repository.ts      # Работа с базой данных
├── cart.module.ts          # Конфигурация модуля
├── entity/
│   └── cart.entity.ts      # Entity с индексами
└── dto/
    ├── product-id.dto.ts           # Валидация ID товара
    ├── product-ids-query.dto.ts    # Валидация списка ID
    ├── add-multiple-to-cart.dto.ts # Валидация batch добавления
    └── remove-multiple-from-cart.dto.ts # Валидация batch удаления
```

## Кеширование

Модуль использует двухуровневое кеширование:
- **Кеш корзины**: Полная информация о товарах в корзине
- **Кеш количества**: Количество товаров в корзине

Кеш автоматически инвалидируется при изменениях в корзине.

## Индексы базы данных

Добавлены индексы для оптимизации запросов:
- `(user_id, product_id)` - уникальный индекс
- `(user_id)` - для поиска по пользователю
- `(product_id)` - для поиска по продукту

## Примеры использования

### Добавление товара
```typescript
POST /cart/123
Authorization: Bearer <token>
```

### Batch добавление
```typescript
POST /cart/multiple
Authorization: Bearer <token>
Content-Type: application/json

{
  "productIds": [1, 2, 3, 4, 5]
}
```

### Получение корзины
```typescript
GET /cart
Authorization: Bearer <token>
```

### Проверка статуса
```typescript
GET /cart/status?productIds=1,2,3,4,5
Authorization: Bearer <token>
```

## Обработка ошибок

Модуль предоставляет детальные сообщения об ошибках:
- `400 Bad Request` - Неверные входные данные
- `404 Not Found` - Пользователь или товар не найден
- `401 Unauthorized` - Не авторизован

## Производительность

- **Batch операции**: До 50 товаров за запрос
- **Кеширование**: TTL настраивается в конфигурации
- **Индексы**: Оптимизированные запросы к базе данных
- **Валидация**: Быстрая проверка входных данных

## Зависимости

- `@nestjs/common` - Основные декораторы
- `@nestjs/typeorm` - Работа с базой данных
- `class-validator` - Валидация DTO
- `@nestjs/swagger` - API документация
- `class-transformer` - Трансформация данных
