# Обработка ошибок загрузки файлов

## Обзор

Система обработки ошибок загрузки файлов обеспечивает надежную и стабильную работу при загрузке изображений продуктов. Реализованы все требования по graceful fallback и удалению неполных файлов при ошибках.

## Компоненты системы

### 1. FileUploadErrorHandlerService
Основной сервис для обработки ошибок загрузки файлов.

**Основные возможности:**
- ✅ Graceful fallback при ошибках загрузки
- ✅ Удаление неполных файлов при ошибках
- ✅ Retry механизм с экспоненциальной задержкой
- ✅ Валидация файлов с fallback
- ✅ Обработка ошибок с откатом изменений

**Ключевые методы:**
- `handleUploadErrors()` - обработка ошибок с graceful fallback
- `handleUploadWithRollback()` - обработка с откатом при критических ошибках
- `cleanupPartialUploads()` - удаление неполных файлов
- `processWithRetry()` - повторные попытки с задержкой
- `validateFileWithFallback()` - валидация с fallback

### 2. ImageOptimizationService
Сервис для обработки и оптимизации изображений.

**Возможности:**
- Сжатие изображений с сохранением качества
- Создание миниатюр
- Валидация форматов и размеров
- Обработка ошибок с cleanup

### 3. UploadMonitoringService
Сервис для мониторинга и анализа ошибок загрузки.

**Функции:**
- Сбор статистики загрузок
- Анализ трендов ошибок
- Генерация рекомендаций
- Мониторинг состояния системы

## Реализованные требования

### ✅ Graceful fallback при ошибках загрузки

1. **Продолжение обработки других файлов**
   - При ошибке одного файла система продолжает обработку остальных
   - Каждый файл обрабатывается независимо

2. **Fallback изображения**
   - При ошибке загрузки используется дефолтное изображение
   - Система не падает при проблемах с отдельными файлами

3. **Retry механизм**
   - Автоматические повторные попытки при временных ошибках
   - Экспоненциальная задержка между попытками

### ✅ Удаление неполных файлов при ошибках

1. **Автоматическая очистка**
   - При ошибке удаляются все частично загруженные файлы
   - Очистка происходит как при отдельных ошибках, так и при критических

2. **Rollback механизм**
   - При критических ошибках (менее 70% успешных загрузок) удаляются все файлы
   - Предотвращение накопления "мусорных" файлов

3. **Валидация целостности**
   - Проверка размера, формата и содержимого файлов
   - Отклонение поврежденных или некорректных файлов

## Примеры использования

### Обработка загрузки с graceful fallback

```typescript
const uploadResult = await this.errorHandlerService.handleUploadWithRollback(
    validFiles,
    async (file) => {
        const retryResult = await this.errorHandlerService.processWithRetry(
            file,
            async (fileToProcess) => {
                return await this.imageOptimizationService.processAndSave(
                    fileToProcess.buffer,
                    fileToProcess.originalname,
                    options
                );
            },
            3 // 3 попытки
        );
        
        if (!retryResult.success) {
            throw new Error(retryResult.error);
        }
        
        return retryResult.filePath!;
    },
    0.7 // 70% файлов должны быть успешно обработаны
);
```

### Валидация файлов с fallback

```typescript
const validationResults = await Promise.all(
    files.map(async (file) => {
        try {
            return await this.errorHandlerService.validateFileWithFallback(file);
        } catch (error) {
            return { valid: false, error: error.message };
        }
    })
);
```

## Мониторинг и диагностика

### API endpoints для администраторов

- `GET /admin/upload-stats` - статистика загрузок
- `GET /admin/system-warnings` - предупреждения системы
- `DELETE /admin/upload-history` - очистка истории

### Логирование

Система ведет детальное логирование всех операций:
- Время обработки каждого файла
- Детали ошибок с stack trace
- Статистика успешных/неудачных загрузок
- Предупреждения о потенциальных проблемах

### Метрики

Отслеживаются следующие показатели:
- Общий процент успешных загрузок
- Тренды ошибок (увеличение/уменьшение/стабильность)
- Средний размер файлов
- Частота различных типов ошибок

## Рекомендации по использованию

1. **Мониторинг**: Регулярно проверяйте статистику загрузок
2. **Логи**: Анализируйте логи для выявления паттернов ошибок
3. **Ресурсы**: Следите за дисковым пространством и памятью
4. **Форматы**: Используйте поддерживаемые форматы изображений
5. **Размеры**: Оптимизируйте размеры файлов перед загрузкой

## Безопасность

- Валидация MIME типов и расширений файлов
- Ограничение размера файлов
- Генерация уникальных имен файлов
- Изоляция загруженных файлов в отдельной директории
- Автоматическая очистка поврежденных файлов
